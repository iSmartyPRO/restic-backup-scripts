# Функция Backup-ToSFTP на PowerShell

Функция `Backup-ToSFTP` для PowerShell автоматизирует процесс резервного копирования с использованием утилиты `restic`. Она позволяет настроить источники и параметры резервного копирования, подключение по SFTP, ведение логов, отправку уведомлений по электронной почте и применение политики хранения данных.

## Возможности

- **Автоматическое резервное копирование**: Архивирует указанные директории на удалённый SFTP-репозиторий.
- **Настраиваемая политика хранения**: Управляет удалением старых резервных копий (например, последних, ежедневных, ежемесячных).
- **Логирование и ротация**: Ведёт логи с отметкой времени и управляет накоплением логов.
- **Уведомления по электронной почте**: Отправляет уведомления по электронной почте с подробной информацией о результатах.
- **Снимки файловой системы**: Использует снимки (если включено) для минимизации прерываний работы во время резервного копирования.

## Требования

- **PowerShell**: Версия 5.1 или выше.
- **Restic**: Загрузка и настройка restic (https://restic.net/).
- **SFTP-сервер**: Для хранения резервных копий.
- **SMTP-сервер**: Для отправки уведомлений по электронной почте.

## Конфигурационный файл (`config.json`)

Функция требует JSON-файла конфигурации, содержащего параметры резервного копирования, настройки SFTP, политику хранения и другие параметры.

### Пример `backup-config.json`

```json
{
    "ProjectName": "MyBackupProject",
    "LogPath": "./logs",
    "BackupSource": "./data",
    "ResticPath": "./restic.exe",
    "Repository": "sftp:user@host:/backup/location",
    "ResticPassword": "YourSecurePassword",
    "UseFsSnapshot": true,
    "RetentionPolicy": {
        "KeepLast": 7,
        "KeepDaily": 7,
        "KeepWeekly": 4,
        "KeepMonthly": 12,
        "KeepYearly": 2
    },
    "EmailSettings": {
        "SmtpServer": "smtp.example.com",
        "SmtpPort": 587,
        "SmtpUser": "user@example.com",
        "SmtpPassword": "YourEmailPassword",
        "From": "no-reply@example.com",
        "To": "user@example.com"
    }
}
```
Описание параметров конфигурации

**ProjectName:** Название проекта, отображается в логах и уведомлениях.
**LogPath:** Путь для хранения логов.
**BackupSource:** Директория, которую нужно архивировать.
**ResticPath:** Путь к исполняемому файлу restic.
**Repository:** URL SFTP-репозитория (например, sftp:user@host:/path).
**ResticPassword:** Пароль для репозитория restic.
**UseFsSnapshot:** Включение создания снимков файловой системы.
**RetentionPolicy:** Политика хранения резервных копий:
**KeepLast:** Количество последних снимков.
**KeepDaily:** Количество ежедневных снимков.
**KeepWeekly:** Количество еженедельных снимков.
**KeepMonthly:** Количество ежемесячных снимков.
**KeepYearly:** Количество ежегодных снимков.
**EmailSettings:** Параметры SMTP для уведомлений.


# Использование

Склонируйте репозиторий или загрузите скрипт Backup-ToSFTP.ps1 в подходящую директорию.

Создайте файл config.json по примеру выше.
Запустите функцию Backup-ToSFTP, указав путь к конфигурационному файлу:
```powershell
Backup-ToSFTP -ConfigPath "C:\Path\To\config.json"
```
### Описание функции
#### Параметры
**ConfigPath:** Путь к JSON-файлу конфигурации.

Пример использования

```powershell
Backup-ToSFTP -ConfigPath "C:\Configs\backup-config.json"
```

# Схема работы функции

**Проверка конфигурации:** Загружает параметры из JSON-файла.

**Инициализация логов:** Настраивает файл логов с именем, содержащим временную метку.

**Проверка репозитория:** Проверяет наличие репозитория, при необходимости инициализирует его.

**Выполнение резервного копирования:** Запускает команду restic для резервного копирования.'

**Применение политики хранения:** Удаляет старые снимки по правилам из конфигурации.

**Уведомление по электронной почте:** Отправляет письмо с результатами резервного копирования.

**Ротация логов:** Управляет накоплением логов для предотвращения избыточного роста файлов.

# Логирование

Логи сохраняются в директорию LogPath с именами вида ProjectName-yyyyMMddHHmmss.log. Каждая запись в логе включает:

Отметку времени
Уровень логирования (INFO, ERROR)
Детали сообщения

# Уведомления по электронной почте
Письмо содержит:

Название проекта
Путь к использованному конфигурационному файлу
Время начала и завершения резервного копирования
Статус выполнения (успех или ошибка)
Детали ошибок, если они произошли
Лицензия
Этот проект лицензирован под лицензией MIT. См. файл LICENSE для подробностей.

# Заметки
Убедитесь, что пароль restic и данные для SMTP хранятся в защищённом виде.
Настройте SFTP-сервер для предоставления прав на чтение и запись для restic.
Если у вас есть вопросы или предложения, создайте обсуждение или отправьте pull-запрос на GitHub.


### Описание содержания README

- **Введение**: Краткое описание функции `Backup-ToSFTP` и её назначения.
- **Требования**: Перечисление необходимых зависимостей для запуска скрипта.
- **Конфигурация**: Подробное описание формата `backup-config.json`.
- **Использование**: Пошаговое руководство по настройке и запуску функции.
- **Схема работы функции**: Краткое описание этапов выполнения скрипта.
- **Логирование и уведомления**: Описание структуры логов и информации, отправляемой в письме.
- **Лицензия и заметки**: Дополнительные сведения для пользователей. 